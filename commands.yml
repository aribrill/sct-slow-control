# Command definitions
# Low level command (one command for a single device):
# 'command_name':
#   device: 'device'
#   command: 'command'
#   args: # optional. default: {}
#       - 'arg1': 'default_val'
#       - 'arg2': null # no default val - arg must be specified by user
#       ... # vals for some, all, or none of args may be specified
#
# High level command (list of commands which may be for different devices):
# 'command_name':
#   command_list:
#       - 'command_name_1'
#       - 'command_name_2'
#       ...
#   args: # optional. default: {}
#       'arg1': {index: 0, arg: 'command1_arg1', val: null}
#       'arg2': {index: 0, arg: 'command1_arg2', val: 'default_val'}
#       'arg3': {index: 1, arg: 'command2_arg', val: 'default_val'}
#       ... # vals for some, all, or none of args may be specified
#
# User-provided argument vals may override those specified with the val
# parameter. The commands in a high level command command_list may themselves
# be either low level or high level commands.
---

# Low level commands
fan:open_connection: {device: fan, command: open_connection}
fan:close_connection: {device: fan, command: close_connection}
fan:turn_on: {device: fan, command: turn_on}
fan:turn_off: {device: fan, command: turn_off}
fan:read_voltage: {device: fan, command: read_voltage}
fan:read_current: {device: fan, command: read_current}
power:turn_on_main_switch: {device: power, command: turn_on_main_switch}
power:turn_off_main_switch: {device: power, command: turn_off_main_switch}
power:start_supply: {device: power, command: start_supply}
power:stop_supply: {device: power, command: stop_supply}
power:start_HV: {device: power, command: start_HV}
power:stop_HV: {device: power, command: stop_HV}
power:read_supply_current: {device: power, command: read_supply_current}
power:read_supply_measured_voltage:
    device: power
    command: read_supply_measured_voltage
power:read_supply_nominal_voltage:
    device: power
    command: read_supply_nominal_voltage
power:read_HV_current: {device: power, command: read_HV_current}
power:read_HV_measured_voltage:
    device: power
    command: read_HV_measured_voltage
power:read_HV_nominal_voltage:
    device: power
    command: read_HV_nominal_voltage
print:
    device: server
    command: print_message
    args: {message: null}
set_alert:
    device: server
    command: set_alert
    args:
        device: null
        variable: null
        lower_limit: null
        upper_limit: null

# Special commands with device 'null' to set execution mode
# Every mode entering command must have a corresponding mode exit afterward

enter_repeat_mode:
    device: null
    command: enter_repeat_mode
    args:
        interval: null  # seconds
        n_executions: null  # Set to a integer > 0, or None to repeat forever
        execute_immediately: 'False'
exit_repeat_mode:
    device: null
    command: exit_repeat_mode

# High level commands (composed of multiple low level commands)

monitor:
    command_list:
        - set_alert  # fan voltage
        - set_alert  # fan current
        - set_alert  # main power supply current
        - set_alert  # HV current
        - enter_repeat_mode
        - fan:read_voltage
        - fan:read_current
        - power:read_supply_current
        - power:read_HV_current
        - exit_repeat_mode
    args:
        alert1_device: {index: 0, arg: device, val: fan}
        alert1_variable: {index: 0, arg: variable, val: voltage}
        alert1_lower_limit: {index: 0, arg: lower_limit, val: 23}  # V
        alert1_upper_limit: {index: 0, arg: upper_limit, val: 25}  # V
        alert2_device: {index: 1, arg: device, val: fan}
        alert2_variable: {index: 1, arg: variable, val: current}
        alert2_lower_limit: {index: 1, arg: lower_limit, val: 14}  # A
        alert2_upper_limit: {index: 1, arg: upper_limit, val: 16}  # A
        alert3_device: {index: 2, arg: device, val: power}
        alert3_variable: {index: 2, arg: variable, val: supply_current}
        alert3_lower_limit: {index: 2, arg: lower_limit, val: 0}  # A
        alert3_upper_limit: {index: 2, arg: upper_limit, val: 4}  # A
        alert4_device: {index: 3, arg: device, val: power}
        alert4_variable: {index: 3, arg: variable, val: HV_current}
        alert4_lower_limit: {index: 3, arg: lower_limit, val: 0}  # A
        alert4_upper_limit: {index: 3, arg: upper_limit, val: 1}  # A
        repeat_interval: {index: 4, arg: interval, val: 30}
        n_executions: {index: 4, arg: n_executions, val: null}
        execute_immediately: {index: 4, arg: execute_immediately, val: 'True'}

start_fans:
    command_list:
        - fan:turn_on
        - fan:read_current
        - fan:read_voltage

stop_fans:
    command_list:
        - fan:turn_off
        - fan:read_current
        - fan:read_voltage

power_on_camera:
    command_list:
        - power:start_main_switch
        - power:start_supply
        - power:read_supply_nominal_voltage
        - power:read_supply_measured_voltage
        - power:read_supply_current

power_off_camera:
    command_list:
        - power:stop_supply
        - power:stop_main_switch
        - power:read_supply_nominal_voltage
        - power:read_supply_measured_voltage
        - power:read_supply_current

test_server:
    command_list:
        - print
        - print
        - test_server2
    args:
        message1:
            index: 0
            arg: message
            val: "Testing the slow control server."
        message2: {index: 1, arg: message, val: "It's working!"}

test_server2:
    command_list:
        - print
        - print
        - test_server3
    args:
        message1: {index: 0, arg: message, val: "Here's another message"}
        message2: {index: 1, arg: message, val: "Yup, still working!"}

test_server3:
    command_list:
        - print
        - enter_repeat_mode
        - print
        - enter_repeat_mode
        - print
        - exit_repeat_mode
        - enter_repeat_mode
        - print
        - exit_repeat_mode
        - exit_repeat_mode
        - print
    args:
        msg1: {index: 0, arg: message, val: "Trying stuff..."}
        interval_1: {index: 1, arg: interval, val: 6}
        n_executions_1: {index: 1, arg: n_executions, val: 3}
        execute_immediately: {index: 1, arg: execute_immediately, val: 'True'}
        msg2: {index: 2, arg: message, val: "Hello,"}
        interval_2: {index: 3, arg: interval, val: 1}
        n_executions_2: {index: 3, arg: n_executions, val: 4}
        msg3: {index: 4, arg: message, val: 'W-'}
        interval_3: {index: 6, arg: interval, val: 5}
        n_executions_3: {index: 6, arg: n_executions, val: 1}
        msg4: {index: 7, arg: message, val: "World!"}
        msg5: {index: 10, arg: message, val: "Stuff tried."}
